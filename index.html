<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gyors Címrendező & Navigáció - Brute Force</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root { --radius: 12px; }
  html, body { height: 100%; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 0; padding: 16px; background:#f6f7fb; color:#111;
  }
  .app {
    max-width: 900px; margin: 0 auto; background:#fff; padding: 16px;
    border-radius: var(--radius); box-shadow: 0 12px 40px rgba(0,0,0,.08);
  }
  h1 { font-size: 1.25rem; margin: 0 0 8px; }
  p.hint { margin-top: 0; color:#444; font-size: .95rem; }
  textarea {
    width: 100%; min-height: 160px; resize: vertical; padding: 12px;
    border-radius: var(--radius); border:1px solid #d8dbe4; font-size: 1rem;
    box-sizing: border-box;
  }
  .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .row > * { flex: 1; }
  .row .tight { flex: 0 0 auto; }
  .btn {
    appearance:none; border:0; border-radius: 10px; padding: 12px 16px;
    background:#111; color:#fff; font-weight: 600; cursor: pointer;
    text-decoration: none; display: inline-block; text-align: center;
  }
  .btn:disabled { background:#ccc; cursor: not-allowed; }
  .btn.secondary { background:#e9ecf4; color:#111; }
  .btn.ghost { background:transparent; color:#111; border:1px solid #d8dbe4; }
  .small { font-size: .9rem; color:#555; }
  .list { margin-top: 16px; }
  .card {
    border:1px solid #e6e8ef; border-radius: 12px; padding: 12px; margin: 8px 0;
    display:flex; gap: 12px; align-items: center; justify-content: space-between;
  }
  .addr { font-weight: 600; }
  .muted { color:#666; font-size: .9rem; }
  .right { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
  details { margin-top: 10px; }
  kbd { background:#f3f5fb; border:1px solid #e4e7f0; border-bottom-width:2px; padding:2px 6px; border-radius:6px; }
  .foot { margin-top: 16px; color:#666; font-size:.9rem; }
  .pill { background:#f2f5ff; border:1px solid #dbe3ff; color:#1b3ea3; padding:4px 8px; border-radius:999px; font-size:.8rem; }
  select { width:100%; padding:10px; border-radius:10px; border:1px solid #d8dbe4; box-sizing: border-box; }
  .error { color: #d32f2f; background: #ffebee; padding: 12px; border-radius: var(--radius); margin: 8px 0; }
  .success { color: #2e7d32; background: #e8f5e8; padding: 12px; border-radius: var(--radius); margin: 8px 0; }
  .loading { color: #1976d2; background: #e3f2fd; padding: 12px; border-radius: var(--radius); margin: 8px 0; }
  @media (max-width: 600px) {
    .row { flex-direction: column; align-items: stretch; }
    .right { justify-content: center; }
  }
</style>
</head>
<body>
  <div class="app">
    <h1>Gyors Címrendező & Navigáció - Brute Force</h1>
    <p class="hint">Írj be <b>egy címet soronként</b>. Megkérem a telefonod helyzetét, geokódolom a címeket, majd megkeresem az összes lehetséges útvonal közül a legrövidebbet. A címlistában minden cím mellett találsz navigációs gombot is.</p>

    <label for="addresses" class="pill">Címek (egy sor = egy cím)</label>
    <textarea id="addresses" placeholder="Pl.&#10;Kossuth Lajos utca 5, Szeged&#10;Dugonics tér 1, Szeged&#10;Rákóczi út 12, Szeged"></textarea>

    <div class="row" style="margin-top:12px">
      <div>
        <label for="app">Navigációs app</label><br/>
        <select id="app">
          <option value="apple">Apple Maps (iPhone ajánlott)</option>
          <option value="google">Google Maps</option>
          <option value="waze">Waze</option>
        </select>
      </div>
      <div class="tight">
        <button id="go" class="btn">Rendezés + Navigáció</button>
      </div>
    </div>

    <div id="status" class="foot"></div>
    <div id="results" class="list"></div>
  </div>

<script>
const sleep = ms => new Promise(r => setTimeout(r, ms));

// Haversine formula a távolság számításához
function haversine(a, b){
  const R = 6371e3; // Föld sugara méterben
  const toRad = d => d * Math.PI/180;
  const dPhi = toRad(b.lat - a.lat);
  const dLambda = toRad(b.lon - a.lon);
  const phi1 = toRad(a.lat);
  const phi2 = toRad(b.lat);
  const s = Math.sin(dPhi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dLambda/2)**2;
  return 2*R*Math.asin(Math.sqrt(s)); // méterben
}

// Egy cím geokódolása
async function geocodeOne(query){
  const url = new URL("https://nominatim.openstreetmap.org/search");
  url.searchParams.set("q", query);
  url.searchParams.set("format", "json");
  url.searchParams.set("limit", "1");
  url.searchParams.set("addressdetails", "1");
  
  const resp = await fetch(url, {
    headers: { 
      "Accept": "application/json",
      "User-Agent": "courier-route-app/1.0 (personal-use)" 
    }
  });
  
  if(!resp.ok) throw new Error("Hálózati hiba a geokódoláskor");
  const data = await resp.json();
  if(!data || !data[0]) return null;
  
  return {
    display: data[0].display_name,
    lat: parseFloat(data[0].lat),
    lon: parseFloat(data[0].lon),
  };
}

// Geokódolás: bemenet listája címek
async function geocode(addresses, statusEl) {
  const results = [];
  for(let i=0; i<addresses.length; i++) {
    statusEl.textContent = `Geokódolás: ${i+1} / ${addresses.length}`;
    const res = await geocodeOne(addresses[i]);
    if(!res) {
      statusEl.textContent = `Hiba: Nem találtam címet: "${addresses[i]}"`;
      return null;
    }
    results.push(res);
    await sleep(1100); // Nominatim szabályok szerint max 1 lekérdezés/s
  }
  statusEl.textContent = "Geokódolás kész";
  return results;
}

// Permutációk generálása
function permute(arr) {
  if (arr.length <= 1) return [arr];
  const result = [];
  for (let i=0; i<arr.length; i++) {
    const rest = [...arr.slice(0,i), ...arr.slice(i+1)];
    for (const perm of permute(rest)) {
      result.push([arr[i], ...perm]);
    }
  }
  return result;
}

// Össztávolság számítása egy útvonalra (startPont + sorrend)
function totalDistance(start, points){
  let dist = 0;
  let prev = start;
  for(const p of points){
    dist += haversine(prev, p);
    prev = p;
  }
  return dist;
}

// URL generálása navigációhoz egy ponthoz
function makeNavUrl(point, app) {
  const lat = point.lat;
  const lon = point.lon;
  if(app === "apple") return `https://maps.apple.com/?daddr=${lat},${lon}&dirflg=d`;
  if(app === "google") return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
  if(app === "waze") return `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`;
  return "#";
}

document.getElementById("go").addEventListener("click", async () => {
  const statusEl = document.getElementById("status");
  const resultsEl = document.getElementById("results");
  resultsEl.innerHTML = "";
  statusEl.textContent = "";

  const raw = document.getElementById("addresses").value.trim();
  if(!raw) {
    statusEl.textContent = "Adj meg legalább egy címet!";
    return;
  }

  const addresses = raw.split("\n").map(s => s.trim()).filter(s => s.length > 0);
  if(addresses.length < 1) {
    statusEl.textContent = "Adj meg legalább egy címet!";
    return;
  }

  // Lekérjük a kezdőpontot (helyzet)
  statusEl.textContent = "Engedélyezd a helymeghatározást, kérlek...";
  let startCoords;
  try {
    startCoords = await new Promise((res, rej) => {
      navigator.geolocation.getCurrentPosition(pos => {
        res({lat: pos.coords.latitude, lon: pos.coords.longitude});
      }, err => {
        rej(err);
      }, {timeout:10000});
    });
  } catch(e) {
    statusEl.textContent = "Nem sikerült a helyzet lekérése: " + e.message;
    return;
  }

  statusEl.textContent = "Helyzet lekérve, geokódolás indul...";
  
  // Geokódolás
  const points = await geocode(addresses, statusEl);
  if(!points) return;

  // Brute force permutációk
  statusEl.textContent = "Permutációk számolása és útvonal optimalizálás...";
  await sleep(100); // UI frissítéshez

  const perms = permute(points);
  let minDist = Infinity;
  let bestRoute = null;
  
  for (const p of perms){
    const dist = totalDistance(startCoords, p);
    if(dist < minDist){
      minDist = dist;
      bestRoute = p;
    }
  }

  // Eredmény megjelenítése
  statusEl.textContent = `Legjobb útvonal: ${(minDist/1000).toFixed(2)} km hosszú`;

  const navApp = document.getElementById("app").value;

  // Kiinduló pontot megmutatjuk (nem cím, csak info)
  const startDiv = document.createElement("div");
  startDiv.className = "card";
  startDiv.innerHTML = `<div><b>Kiinduló pont (helyzeted):</b> Lat: ${startCoords.lat.toFixed(6)}, Lon: ${startCoords.lon.toFixed(6)}</div>`;
  resultsEl.appendChild(startDiv);

  // Minden cím listázása a bestRoute sorrendben, navigációs gombbal
  bestRoute.forEach((point, i) => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="addr">${i+1}. ${point.display}</div>
      <div class="right">
        <a class="btn ghost" href="${makeNavUrl(point, navApp)}" target="_blank" rel="noopener noreferrer" title="Navigáció ide">${navApp} indítása</a>
      </div>
    `;
    resultsEl.appendChild(div);
  });
});
</script>
</body>
</html>
