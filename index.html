<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Greedy útvonaltervező + Navigáció</title>
<style>
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 20px; background: #f6f7fb; color: #111;
  }
  .app {
    max-width: 900px; margin: 0 auto; background: white;
    padding: 20px; border-radius: 12px; box-shadow: 0 12px 40px rgba(0,0,0,.08);
  }
  h1 { font-size: 1.5rem; margin-bottom: 8px; }
  textarea {
    width: 100%; min-height: 140px; border-radius: 12px; border: 1px solid #ccc;
    padding: 12px; font-size: 1rem; box-sizing: border-box;
  }
  select, button {
    padding: 10px; border-radius: 10px; border: 1px solid #d8dbe4;
    font-size: 1rem; cursor: pointer;
  }
  button {
    background: #111; color: white; font-weight: 600;
    border: none;
  }
  button:disabled {
    background: #aaa; cursor: not-allowed;
  }
  .row {
    display: flex; gap: 12px; margin-top: 12px; flex-wrap: wrap;
    align-items: center;
  }
  .list {
    margin-top: 16px;
  }
  .card {
    border: 1px solid #e6e8ef; border-radius: 12px;
    padding: 12px; margin: 8px 0;
    display: flex; justify-content: space-between; align-items: center;
    flex-wrap: wrap;
  }
  .addr {
    font-weight: 600;
    flex: 1 1 60%;
  }
  .distance {
    color: #666;
    font-size: 0.9rem;
    margin-left: 12px;
    flex: 1 1 20%;
  }
  .nav-btn {
    background: #1b3ea3;
    color: white;
    border-radius: 8px;
    padding: 6px 12px;
    text-decoration: none;
    flex: 0 0 auto;
    font-size: 0.9rem;
  }
  .status {
    margin-top: 12px;
    font-weight: 600;
  }
</style>
</head>
<body>
<div class="app">
  <h1>Greedy útvonaltervező + Navigáció</h1>
  <p>Írj be címeket soronként, a rendszer megkeresi az optimális sorrendet a <b>legközelebbi szomszéd</b> módszerével.<br>Az egyes címek mellett külön navigációs gomb lesz.</p>

  <textarea id="addresses" placeholder="Pl.&#10;Kossuth Lajos utca 5, Szeged&#10;Dugonics tér 1, Szeged&#10;Rákóczi út 12, Szeged"></textarea>

  <div class="row">
    <div>
      <label for="app">Navigációs app</label><br>
      <select id="app">
        <option value="apple">Apple Maps</option>
        <option value="google" selected>Google Maps</option>
        <option value="waze">Waze</option>
      </select>
    </div>
    <div>
      <button id="go">Útvonaltervezés + Navigáció</button>
    </div>
  </div>

  <div id="status" class="status"></div>
  <div id="results" class="list"></div>
</div>

<script>
const sleep = ms => new Promise(r => setTimeout(r, ms));

function haversine(a, b){
  const R = 6371e3;
  const toRad = d => d * Math.PI/180;
  const dPhi = toRad(b.lat - a.lat);
  const dLambda = toRad(b.lon - a.lon);
  const phi1 = toRad(a.lat);
  const phi2 = toRad(b.lat);
  const s = Math.sin(dPhi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dLambda/2)**2;
  return 2*R*Math.asin(Math.sqrt(s));
}

async function geocodeOne(query){
  const url = new URL("https://nominatim.openstreetmap.org/search");
  url.searchParams.set("q", query);
  url.searchParams.set("format", "json");
  url.searchParams.set("limit", "1");
  const resp = await fetch(url, {headers: {"User-Agent": "greedy-route-app/1.0 (personal-use)"}});
  if(!resp.ok) throw new Error("Hiba a geokódolásban");
  const data = await resp.json();
  if(!data || data.length === 0) return null;
  return {
    input: query,
    lat: parseFloat(data[0].lat),
    lon: parseFloat(data[0].lon),
    display: data[0].display_name
  };
}

async function geocodeAll(lines, setStatus){
  const out = [];
  for(let i=0; i<lines.length; i++){
    const line = lines[i].trim();
    if(!line) continue;
    setStatus(`Geokódolás (${i+1}/${lines.length})…`);
    try{
      const geo = await geocodeOne(line);
      if(geo) out.push(geo);
      else console.warn("Nem található cím:", line);
    } catch(e) {
      console.warn("Geokódolási hiba:", e);
    }
    if(i < lines.length-1) await sleep(1000);
  }
  return out;
}

// Greedy útvonaltervező: mindig a legközelebbi pontot választja
function greedyRoute(origin, points) {
  const remaining = points.slice();
  const route = [];

  let current = origin;

  while(remaining.length) {
    let nearestIndex = 0;
    let nearestDist = haversine(current, remaining[0]);
    for(let i=1; i<remaining.length; i++){
      const dist = haversine(current, remaining[i]);
      if(dist < nearestDist){
        nearestDist = dist;
        nearestIndex = i;
      }
    }
    const next = remaining.splice(nearestIndex, 1)[0];
    next.distFromCurrent = nearestDist;
    route.push(next);
    current = next;
  }

  return route;
}

function fmtMeters(m){
  if(m < 1000) return Math.round(m) + " m";
  return (m/1000).toFixed(1).replace(".", ",") + " km";
}

function appleNavLink(lat, lon){
  return `https://maps.apple.com/?daddr=${lat},${lon}&dirflg=d`;
}

function googleNavLink(lat, lon){
  return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
}

function wazeNavLink(lat, lon){
  return `https://waze.com/ul?ll=${lat},${lon}&navigate=yes`;
}

function multiAppleLink(origin, route){
  if(route.length === 0) return null;
  const originStr = `${origin.lat},${origin.lon}`;
  const last = route[route.length-1];
  const destStr = `${last.lat},${last.lon}`;
  const url = new URL("https://maps.apple.com/");
  url.searchParams.set("saddr", originStr);
  url.searchParams.set("daddr", destStr);
  if(route.length > 1){
    const via = route.slice(0, -1).map(p => `${p.lat},${p.lon}`).join("+to:");
    url.searchParams.set("waypoints", via);
  }
  return url.toString();
}

function multiGoogleLink(origin, route){
  if(route.length === 0) return null;
  const originStr = `${origin.lat},${origin.lon}`;
  const stops = route.map(p => `${p.lat},${p.lon}`).join("/");
  return `https://www.google.com/maps/dir/${originStr}/${stops}`;
}

function multiWazeLink(origin, route){
  if(route.length === 0) return null;
  // Waze nem támogat több megállót, csak az elsőt mutatja meg
  const first = route[0];
  return `https://waze.com/ul?ll=${first.lat},${first.lon}&navigate=yes`;
}

document.getElementById("go").addEventListener("click", async () => {
  const status = document.getElementById("status");
  const results = document.getElementById("results");
  status.textContent = "";
  results.innerHTML = "";

  const raw = document.getElementById("addresses").value;
  if(!raw.trim()){
    status.textContent = "Adj meg legalább egy címet!";
    return;
  }
  const lines = raw.split("\n").map(l => l.trim()).filter(Boolean);

  if(!navigator.geolocation){
    status.textContent = "A böngésződ nem támogatja a helyzet lekérést.";
    return;
  }

  status.textContent = "Helyzet kérés…";
  navigator.geolocation.getCurrentPosition(async pos => {
    const origin = { lat: pos.coords.latitude, lon: pos.coords.longitude };

    status.textContent = "Címek geokódolása…";
    let points;
    try{
      points = await geocodeAll(lines, s => status.textContent = s);
    } catch(e) {
      status.textContent = "Hiba a geokódolás során: " + e.message;
      return;
    }

    if(points.length === 0) {
      status.textContent = "Egy címet sem sikerült geokódolni.";
      return;
    }

    status.textContent = "Útvonal kiszámolása…";

    // Greedy útvonal
    const route = greedyRoute(origin, points);

    status.textContent = `Útvonal kész, ${route.length} megálló.`;

    // Eredmények megjelenítése
    for(let i=0; i<route.length; i++){
      const p = route[i];
      const card = document.createElement("div");
      card.className = "card";

      const addrDiv = document.createElement("div");
      addrDiv.className = "addr";
      addrDiv.textContent = `${i+1}. ${p.input}`;

      const distDiv = document.createElement("div");
      distDiv.className = "distance";
      distDiv.textContent = fmtMeters(p.distFromCurrent);

      const app = document.getElementById("app").value;
      let navUrl = null;
      if(app === "apple") navUrl = appleNavLink(p.lat, p.lon);
      else if(app === "google") navUrl = googleNavLink(p.lat, p.lon);
      else if(app === "waze") navUrl = wazeNavLink(p.lat, p.lon);

      const navBtn = document.createElement("a");
      navBtn.href = navUrl;
      navBtn.target = "_blank";
      navBtn.rel = "noopener noreferrer";
      navBtn.className = "nav-btn";
      navBtn.textContent = "Navigálás ide";
      
      card.appendChild(addrDiv);
      card.appendChild(distDiv);
      card.appendChild(navBtn);

      results.appendChild(card);
    }

    // Teljes útvonal navigáció link
    let multiUrl = null;
    const app = document.getElementById("app").value;
    if(app === "apple") multiUrl = multiAppleLink(origin, route);
    else if(app === "google") multiUrl = multiGoogleLink(origin, route);
    else if(app === "waze") multiUrl = multiWazeLink(origin, route);

    if(multiUrl){
      const btn = document.createElement("a");
      btn.href = multiUrl;
      btn.target = "_blank";
      btn.rel = "noopener noreferrer";
      btn.className = "nav-btn";
      btn.style.marginTop = "16px";
      btn.textContent = "Teljes útvonal navigáció";
      results.appendChild(btn);
    }

  }, err => {
    switch(err.code){
      case err.PERMISSION_DENIED: status.textContent = "Helyzetelérés megtagadva."; break;
      case err.POSITION_UNAVAILABLE: status.textContent = "Helyzet nem elérhető."; break;
      case err.TIMEOUT: status.textContent = "Helyzet lekérés időtúllépés."; break;
      default: status.textContent = "Ismeretlen hiba történt a helyzet lekérésekor."; break;
    }
  }, {
    enableHighAccuracy: true,
    timeout: 15000,
    maximumAge: 0
  });
});
</script>
</body>
</html>
