<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Brute Force TSP Apple/Google Maps</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  label { display: block; margin-top: 10px; }
  textarea { width: 100%; height: 100px; }
  select, button { margin-top: 10px; padding: 5px; }
  #result { margin-top: 20px; white-space: pre-wrap; }
</style>
</head>
<body>

<h2>Útvonaltervezés Brute Force TSP-vel</h2>

<label for="origin">Kiindulási pont címe:</label>
<input type="text" id="origin" placeholder="Pl. Budapest, Erzsébet tér 1" style="width:100%;" />

<label for="addresses">Úticélok címei (soronként):</label>
<textarea id="addresses" placeholder="Pl. Váci utca 1&#10;Andrássy út 50"></textarea>

<label for="mapService">Térképszolgáltató:</label>
<select id="mapService">
  <option value="google">Google Maps</option>
  <option value="apple">Apple Maps</option>
</select>

<button id="go">Geokódolás és útvonaltervezés</button>

<div id="result"></div>

<script>
// Haversine távolság km-ben
function haversine(p1, p2) {
  const toRad = v => (v * Math.PI) / 180;
  const R = 6371;
  const dLat = toRad(p2.lat - p1.lat);
  const dLon = toRad(p2.lon - p1.lon);
  const lat1 = toRad(p1.lat);
  const lat2 = toRad(p2.lat);

  const a = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLon/2)**2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// Egyszerű geokódoló (OpenStreetMap Nominatim)
async function geocode(address) {
  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
  const res = await fetch(url);
  const data = await res.json();
  if(data && data.length > 0) {
    return {lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon), display_name: data[0].display_name};
  } else {
    throw new Error(`Nem található hely: ${address}`);
  }
}

// Permutáció generátor
function* permute(arr, n = arr.length) {
  if(n <= 1) yield arr.slice();
  else {
    for(let i=0; i<n; i++) {
      yield* permute(arr, n-1);
      const j = n % 2 === 0 ? i : 0;
      [arr[n-1], arr[j]] = [arr[j], arr[n-1]];
    }
  }
}

// Brute Force TSP algoritmus
function bruteForceTSP(origin, points) {
  if(points.length === 0) return [];

  const dist = (a,b) => haversine(a,b);
  let bestRoute = null;
  let bestDist = Infinity;

  for(const perm of permute(points)) {
    let totalDist = dist(origin, perm[0]);
    for(let i=0; i<perm.length-1; i++) {
      totalDist += dist(perm[i], perm[i+1]);
      if(totalDist > bestDist) break; // korai kilépés
    }
    if(totalDist < bestDist) {
      bestDist = totalDist;
      bestRoute = perm.slice();
    }
  }
  return bestRoute;
}

// Google Maps URL generálása az adott sorrendhez
function generateGoogleMapsURL(origin, points) {
  if(points.length === 0) return "";

  let url = "https://www.google.com/maps/dir/";
  url += encodeURIComponent(origin) + "/";
  points.forEach(p => {
    url += encodeURIComponent(p.display_name) + "/";
  });
  return url;
}

// Apple Maps URL generálása az adott sorrendhez
function generateAppleMapsURL(originCoords, points) {
  if(points.length === 0) return "";

  // Apple Maps nem támogat több pontos útvonalat URL-ben úgy mint Google Maps,
  // ezért csak az első pontig mutatjuk az irányt, vagy egyszerűen megnyitjuk a címet.
  // Az egyszerűség kedvéért megjelenítjük az első pont koordinátáit, de a végleges
  // útvonaltervezéshez az Apple Maps appban kell kézzel kiválasztani a többi címet.

  const base = "https://maps.apple.com/?saddr=";
  const saddr = `${originCoords.lat},${originCoords.lon}`;
  const daddr = `${points[0].lat},${points[0].lon}`;
  return `${base}${saddr}&daddr=${daddr}`;
}

document.getElementById("go").addEventListener("click", async () => {
  const originInput = document.getElementById("origin").value.trim();
  const addressesInput = document.getElementById("addresses").value.trim();
  const mapService = document.getElementById("mapService").value;
  const resultDiv = document.getElementById("result");
  resultDiv.textContent = "Feldolgozás... Kérlek várj.";

  if(!originInput) {
    alert("Kérlek add meg a kiindulási címet!");
    return;
  }
  if(!addressesInput) {
    alert("Kérlek adj meg legalább egy úticélt!");
    return;
  }

  const addresses = addressesInput.split("\n").map(s => s.trim()).filter(s => s.length > 0);

  try {
    // Geokódoljuk a kiindulási pontot
    const originGeo = await geocode(originInput);

    // Geokódoljuk az összes címet
    const geocodedPoints = [];
    for(const addr of addresses) {
      const g = await geocode(addr);
      geocodedPoints.push(g);
    }

    // Brute Force TSP sorrend
    const orderedPoints = bruteForceTSP(originGeo, geocodedPoints);

    // Eredmény megjelenítése és link generálás
    let output = `Optimális útvonal (Brute Force TSP szerint):\n\n`;
    output += `Kiindulási pont: ${originGeo.display_name}\n\n`;
    orderedPoints.forEach((p, i) => {
      output += `${i+1}. ${p.display_name}\n`;
    });

    let mapUrl = "";
    if(mapService === "google") {
      mapUrl = generateGoogleMapsURL(originInput, orderedPoints);
    } else if(mapService === "apple") {
      mapUrl = generateAppleMapsURL(originGeo, orderedPoints);
    }

    output += `\n\n<a href="${mapUrl}" target="_blank">Útvonal megtekintése a kiválasztott térképen</a>`;

    resultDiv.innerHTML = output;

  } catch(err) {
    resultDiv.textContent = "Hiba: " + err.message;
  }
});
</script>

</body>
</html>
