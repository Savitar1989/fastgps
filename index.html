<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" >
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Optimaliz√°lt Sz√°ll√≠t√°si √ötvonaltervez≈ë</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<style>
  :root { --radius: 12px; }
  html, body { height: 100%; }
  body {
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    margin: 0; padding: 16px; background:#f6f7fb; color:#111;
  }
  .app {
    max-width: 900px; margin: 0 auto; background:#fff; padding: 16px;
    border-radius: var(--radius); box-shadow: 0 12px 40px rgba(0,0,0,.08);
  }
  h1 { font-size: 1.25rem; margin: 0 0 8px; }
  p.hint { margin-top: 0; color:#444; font-size: .95rem; }
  textarea {
    width: 100%; min-height: 160px; resize: vertical; padding: 12px;
    border-radius: var(--radius); border:1px solid #d8dbe4; font-size: 1rem;
    box-sizing: border-box;
  }
  .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
  .row > * { flex: 1; }
  .row .tight { flex: 0 0 auto; }
  .btn {
    appearance:none; border:0; border-radius: 10px; padding: 12px 16px;
    background:#111; color:#fff; font-weight: 600; cursor: pointer;
    text-decoration: none; display: inline-block; text-align: center;
  }
  .btn:disabled { background:#ccc; cursor: not-allowed; }
  .btn.secondary { background:#e9ecf4; color:#111; }
  .btn.ghost { background:transparent; color:#111; border:1px solid #d8dbe4; }
  .small { font-size: .9rem; color:#555; }
  .list { margin-top: 16px; }
  .card {
    border:1px solid #e6e8ef; border-radius: 12px; padding: 12px; margin: 8px 0;
    display:flex; gap: 12px; align-items: center; justify-content: space-between;
  }
  .addr { font-weight: 600; }
  .muted { color:#666; font-size: .9rem; }
  .right { display:flex; gap: 8px; align-items:center; flex-wrap: wrap; }
  details { margin-top: 10px; }
  kbd { background:#f3f5fb; border:1px solid #e4e7f0; border-bottom-width:2px; padding:2px 6px; border-radius:6px; }
  .foot { margin-top: 16px; color:#666; font-size:.9rem; }
  .pill { background:#f2f5ff; border:1px solid #dbe3ff; color:#1b3ea3; padding:4px 8px; border-radius:999px; font-size:.8rem; }
  select { width:100%; padding:10px; border-radius:10px; border:1px solid #d8dbe4; box-sizing: border-box; }
  .error { color: #d32f2f; background: #ffebee; padding: 12px; border-radius: var(--radius); margin: 8px 0; }
  .success { color: #2e7d32; background: #e8f5e8; padding: 12px; border-radius: var(--radius); margin: 8px 0; }
  .loading { color: #1976d2; background: #e3f2fd; padding: 12px; border-radius: var(--radius); margin: 8px 0; }
  .optimization-info { 
    background: #fff3e0; 
    border: 1px solid #ffb74d; 
    padding: 12px; 
    border-radius: var(--radius); 
    margin: 8px 0; 
    color: #e65100;
  }
  .route-stats {
    background: #e8f5e8;
    border: 1px solid #4caf50;
    padding: 12px;
    border-radius: var(--radius);
    margin: 8px 0;
    color: #2e7d32;
    font-weight: 600;
  }
  @media (max-width: 600px) {
    .row { flex-direction: column; align-items: stretch; }
    .right { justify-content: center; }
  }
</style>
</head>
<body>
  <div class="app">
    <h1>üöö Optimaliz√°lt Sz√°ll√≠t√°si √ötvonaltervez≈ë</h1>
    <p class="hint">√çrj be <b>egy c√≠met soronk√©nt</b> (max. 8 c√≠m aj√°nlott). A Brute Force algoritmus megtal√°lja a <b>legr√∂videbb √∫tvonalat</b> minden lehets√©ges kombin√°ci√≥ kipr√≥b√°l√°s√°val.</p>

    <label for="addresses" class="pill">C√≠mek (egy sor = egy c√≠m)</label>
    <textarea id="addresses" placeholder="Pl.&#10;Kossuth Lajos utca 5, Szeged&#10;Dugonics t√©r 1, Szeged&#10;R√°k√≥czi √∫t 12, Szeged&#10;Aradi v√©rtan√∫k tere 1, Szeged"></textarea>

    <div class="row" style="margin-top:12px">
      <div>
        <label for="app">Navig√°ci√≥s app</label><br/>
        <select id="app">
          <option value="apple">Apple Maps (iPhone aj√°nlott)</option>
          <option value="google">Google Maps</option>
          <option value="waze">Waze</option>
        </select>
      </div>
      <div class="tight">
        <button id="go" class="btn">üß† Optim√°lis √∫tvonal keres√©se</button>
      </div>
    </div>

    <details>
      <summary>Algoritmus inform√°ci√≥k</summary>
      <div style="margin-top:8px" class="small">
        <strong>Brute Force Optimaliz√°ci√≥:</strong> Az algoritmus minden lehets√©ges √∫tvonal-sorrendet megvizsg√°l √©s a legr√∂videbb √∂sszutakat v√°lasztja.<br/>
        <strong>Teljes√≠tm√©ny:</strong> 4 c√≠m = 24 kombin√°ci√≥, 5 c√≠m = 120, 6 c√≠m = 720, 7 c√≠m = 5040, 8 c√≠m = 40320.<br/>
        <strong>Geok√≥dol√°s:</strong> Nominatim (OpenStreetMap). Udvarias 1 mp/k√©r√©s korl√°toz√°ssal.<br/>
        <strong>T√°vols√°gsz√°m√≠t√°s:</strong> Haversine formula (l√©gvonalbeli t√°vols√°g).
      </div>
    </details>

    <div id="status" class="foot"></div>
    <div id="results" class="list"></div>
  </div>

<script>
const sleep = ms => new Promise(r => setTimeout(r, ms));

// Haversine formula a t√°vols√°g sz√°m√≠t√°s√°hoz
function haversine(a, b){
  const R = 6371e3; // F√∂ld sugara m√©terben
  const toRad = d => d * Math.PI/180;
  const dPhi = toRad(b.lat - a.lat);
  const dLambda = toRad(b.lon - a.lon);
  const phi1 = toRad(a.lat);
  const phi2 = toRad(b.lat);
  const s = Math.sin(dPhi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dLambda/2)**2;
  return 2*R*Math.asin(Math.sqrt(s)); // m√©terben
}

// Egy c√≠m geok√≥dol√°sa
async function geocodeOne(query){
  const url = new URL("https://nominatim.openstreetmap.org/search");
  url.searchParams.set("q", query);
  url.searchParams.set("format", "json");
  url.searchParams.set("limit", "1");
  url.searchParams.set("addressdetails", "1");
  
  const resp = await fetch(url, {
    headers: { 
      "Accept": "application/json",
      "User-Agent": "optimal-delivery-route-app/2.0 (brute-force-optimization)" 
    }
  });
  
  if(!resp.ok) throw new Error("H√°l√≥zati hiba a geok√≥dol√°skor");
  const data = await resp.json();
  if(!data || !data[0]) return null;
  
  return {
    display: data[0].display_name,
    lat: parseFloat(data[0].lat),
    lon: parseFloat(data[0].lon)
  };
}

// √ñsszes c√≠m geok√≥dol√°sa
async function geocodeAll(lines, setStatus){
  const out = [];
  for(let i=0; i<lines.length; i++){
    const q = lines[i].trim();
    if(!q) continue;
    
    setStatus(`Geok√≥dol√°s (${i+1}/${lines.length})‚Ä¶`, 'loading');
    
    try{
      const g = await geocodeOne(q);
      if(g) {
        out.push({ input: q, ...g });
      } else {
        console.warn(`Nem tal√°lhat√≥ c√≠m: ${q}`);
      }
    } catch(e) {
      console.warn("Geok√≥dol√°s hiba:", e);
    }
    
    // Udvarias throttling - 1 m√°sodperc v√°rakoz√°s
    if(i < lines.length - 1) {
      await sleep(1000);
    }
  }
  return out;
}

// Permut√°ci√≥k gener√°l√°sa
function generatePermutations(arr) {
  if (arr.length <= 1) return [arr];
  const result = [];
  for (let i = 0; i < arr.length; i++) {
    const current = arr[i];
    const remaining = arr.slice(0, i).concat(arr.slice(i + 1));
    const perms = generatePermutations(remaining);
    for (const perm of perms) {
      result.push([current, ...perm]);
    }
  }
  return result;
}

// √ötvonal hossz√°nak kisz√°m√≠t√°sa
function calculateRouteDistance(origin, route) {
  if (!route || route.length === 0) return 0;
  
  let totalDistance = 0;
  let currentPos = origin;
  
  for (const point of route) {
    totalDistance += haversine(currentPos, point);
    currentPos = point;
  }
  
  return totalDistance;
}

// Brute Force optimaliz√°ci√≥
function bruteForceOptimization(origin, points, setStatus) {
  const startTime = Date.now();
  
  if (points.length === 0) return { route: [], distance: 0, stats: null };
  if (points.length === 1) {
    const distance = haversine(origin, points[0]);
    return { 
      route: points, 
      distance,
      stats: { permutations: 1, timeMs: Date.now() - startTime }
    };
  }

  // Figyelmeztet√©s nagy kombin√°ci√≥sz√°mn√°l
  const factorial = (n) => n <= 1 ? 1 : n * factorial(n - 1);
  const permutationCount = factorial(points.length);
  
  if (permutationCount > 5000) {
    setStatus(`‚ö†Ô∏è ${permutationCount.toLocaleString()} kombin√°ci√≥ vizsg√°lata... Ez eltarthat egy ideig.`, 'loading');
  } else {
    setStatus(`üîç ${permutationCount} lehets√©ges √∫tvonal vizsg√°lata...`, 'loading');
  }

  // √ñsszes permut√°ci√≥ gener√°l√°sa
  const allPermutations = generatePermutations(points);
  let bestRoute = null;
  let shortestDistance = Infinity;

  // Minden permut√°ci√≥ kipr√≥b√°l√°sa
  for (let i = 0; i < allPermutations.length; i++) {
    const route = allPermutations[i];
    const distance = calculateRouteDistance(origin, route);
    
    if (distance < shortestDistance) {
      shortestDistance = distance;
      bestRoute = route;
    }

    // Id≈ënk√©nti st√°tusz friss√≠t√©s nagyobb sz√°m√≠t√°sok eset√©n
    if (permutationCount > 1000 && i % 1000 === 0) {
      const progress = ((i / allPermutations.length) * 100).toFixed(1);
      setStatus(`üîç Optimaliz√°ci√≥ folyamatban... ${progress}% (${i}/${allPermutations.length})`, 'loading');
    }
  }

  const endTime = Date.now();
  
  return {
    route: bestRoute || [],
    distance: shortestDistance,
    stats: {
      permutations: permutationCount,
      timeMs: endTime - startTime
    }
  };
}

// T√°vols√°g form√°z√°sa
function fmtMeters(m){
  if(m < 1000) return Math.round(m) + " m";
  return (m/1000).toFixed(1).replace(".", ",") + " km";
}

// Apple Maps t√∂bb meg√°ll√≥val
function appleMultiLink(origin, destinations){
  if(!destinations || !destinations.length) return null;
  let url = `maps://?dirflg=d&saddr=${origin.lat},${origin.lon}`;
  destinations.forEach(p => {
    url += `&daddr=${p.lat},${p.lon}`;
  });
  return url;
  return u.toString();
}

// Apple Maps link gener√°l√°sa (1 c√©lpont)
function appleLink(origin, destination){
  if(!destination) return null;
  const d = encodeURIComponent(`${destination.lat},${destination.lon}`);
  const o = encodeURIComponent(`${origin.lat},${origin.lon}`);
  return `https://maps.apple.com/?saddr=${o}&daddr=${d}`;
}

// Google Maps link gener√°l√°sa
function googleLink(origin, destinations){
  if(!destinations.length) return null;
  
  const o = `${origin.lat},${origin.lon}`;
  const dest = `${destinations[destinations.length-1].lat},${destinations[destinations.length-1].lon}`;
  
  let url;
  if(destinations.length === 1) {
    url = new URL("https://www.google.com/maps/dir/");
    url.searchParams.set("api", "1");
    url.searchParams.set("origin", o);
    url.searchParams.set("destination", dest);
  } else {
    const waypoints = destinations.slice(0, destinations.length-1)
      .map(p => `${p.lat},${p.lon}`).join("|");
    
    url = new URL("https://www.google.com/maps/dir/");
    url.searchParams.set("api", "1");
    url.searchParams.set("origin", o);
    url.searchParams.set("destination", dest);
    if(waypoints) url.searchParams.set("waypoints", waypoints);
  }
  
  return url.toString();
}

// Waze link gener√°l√°sa
function wazeLink(origin, destination){
  if(!destination) return null;
  const ll = `${destination.lat},${destination.lon}`;
  return `https://waze.com/ul?ll=${encodeURIComponent(ll)}&navigate=yes`;
}

// Eredm√©nyek megjelen√≠t√©se
function renderList(container, origin, optimizedResult){
  container.innerHTML = "";
  
  const { route, distance, stats } = optimizedResult;
  
  if(!route.length) return;

  // Optimaliz√°ci√≥s statisztik√°k
  if(stats) {
    const statsCard = document.createElement("div");
    statsCard.className = "route-stats";
    statsCard.innerHTML = `
      <strong>üéØ Optim√°lis √∫tvonal tal√°lva!</strong><br>
      üìä ${stats.permutations.toLocaleString()} kombin√°ci√≥ vizsg√°lva ${stats.timeMs}ms alatt<br>
      üìè Teljes √∫tvonalhossz: ${fmtMeters(distance)}
    `;
    container.appendChild(statsCard);
  }
  
  // Teljes √∫tvonal gomb (ha t√∂bb mint 1 c√≠m van)
  if(route.length >= 2){
    const allCard = document.createElement("div");
    allCard.className = "card";
    
    const left = document.createElement("div");
    left.innerHTML = "<div class='addr'>üó∫Ô∏è Teljes optimaliz√°lt √∫tvonal</div><div class='muted'>√ñsszes meg√°ll√≥ optim√°lis sorrendben</div>";
    
    const right = document.createElement("div");
    right.className = "right";
    
    const gAll = document.createElement("a");
    gAll.className = "btn";
    gAll.textContent = "üó∫Ô∏è Google Maps";
    gAll.href = googleLink(origin, route);
    gAll.onclick = function(e) {
      const isMobile = /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      if(isMobile) {
        e.preventDefault();
        window.location.href = this.href;
        return false;
      }
    };

    const aAll = document.createElement("a");
aAll.className = "btn secondary";
aAll.textContent = "Apple Maps";

// Use your dynamic appleMultiLink function, but make sure it returns a maps:// link for iOS
const appleMapsURL = appleMultiLink(origin, route); // Should be like "maps://?daddr=destination"
aAll.href = appleMapsURL;

// Only add target/rel for desktop, not for iOS
const isMobile = /iPhone|iPad|iPod/i.test(navigator.userAgent);

if (!isMobile) {
  aAll.target = "_blank";
  aAll.rel = "noopener";
}

// On iOS, override the link click to use window.location
aAll.onclick = function(e) {
  if (isMobile) {
    e.preventDefault();
    window.location.href = appleMapsURL;
    return false;
  }
};

right.appendChild(aAll);
  
  // Egyedi c√≠mek optimaliz√°lt sorrendben
  route.forEach((p, idx) => {
    const distFromOrigin = haversine(origin, p);
    const card = document.createElement("div");
    card.className = "card";
    
    const left = document.createElement("div");
    const title = document.createElement("div");
    title.className = "addr";
    title.textContent = `${idx+1}. ${p.input}`;
    
    const sub = document.createElement("div");
    sub.className = "muted";
    sub.textContent = `${fmtMeters(distFromOrigin)} a kiindul√≥pontt√≥l ‚Ä¢ ${p.display.split(',').slice(0,2).join(',')}`;
    
    left.appendChild(title);
    left.appendChild(sub);
    
    const right = document.createElement("div");
    right.className = "right";
    
    const gBtn = document.createElement("a");
    gBtn.className = "btn secondary";
    gBtn.textContent = "Google";
    gBtn.href = googleLink(origin, [p]);
    gBtn.target = "_blank";
    
    const aBtn = document.createElement("a");
    aBtn.className = "btn ghost";
    aBtn.textContent = "Apple";
    aBtn.href = appleLink(origin, p);
    aBtn.target = "_blank";
    aBtn.rel = "noopener";
    
    const wBtn = document.createElement("a");
    wBtn.className = "btn ghost";
    wBtn.textContent = "Waze";
    wBtn.href = wazeLink(origin, p);
    wBtn.target = "_blank";
    
    right.appendChild(gBtn);
    right.appendChild(aBtn);
    right.appendChild(wBtn);
    
    card.appendChild(left);
    card.appendChild(right);
    container.appendChild(card);
  });
}

// St√°tusz be√°ll√≠t√°sa
function setStatus(message, type = 'info') {
  const status = document.getElementById("status");
  status.textContent = message;
  status.className = `foot ${type}`;
}

// F≈ëfunkci√≥
async function main(){
  const results = document.getElementById("results");
  
  document.getElementById("go").addEventListener("click", async () => {
    const goBtn = document.getElementById("go");
    goBtn.disabled = true;
    goBtn.textContent = "üß† Optimaliz√°l√°s...";
    
    try {
      results.innerHTML = "";
      setStatus("üìç Helyzet lek√©r√©se‚Ä¶", 'loading');
      
      let origin;
      try {
        origin = await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            position => resolve({ 
              lat: position.coords.latitude, 
              lon: position.coords.longitude 
            }),
            error => reject(error),
            { 
              enableHighAccuracy: true, 
              timeout: 15000,
              maximumAge: 60000 
            }
          );
        });
      } catch(e) {
        setStatus("‚ùå Nem siker√ºlt lek√©rni a helyzetet. Enged√©lyezd a helymeghat√°roz√°st a b√∂ng√©sz≈ëben.", 'error');
        return;
      }
      
      const lines = document.getElementById("addresses").value
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean);
      
      if(!lines.length) { 
        setStatus("‚ùå Adj meg legal√°bb egy c√≠met.", 'error'); 
        return; 
      }
      
      if(lines.length > 8) {
        setStatus("‚ö†Ô∏è Figyelem: 8-n√°l t√∂bb c√≠m eset√©n a sz√°m√≠t√°s nagyon lass√∫ lehet. Aj√°nlott maximum 8 c√≠m haszn√°lata.", 'optimization-info');
      }
      
      setStatus("üåç C√≠mek geok√≥dol√°sa‚Ä¶", 'loading');
      const geocoded = await geocodeAll(lines, setStatus);
      
      if(!geocoded.length) { 
        setStatus("‚ùå Egy c√≠met sem siker√ºlt beazonos√≠tani.", 'error'); 
        return; 
      }
      
      // Brute Force optimaliz√°ci√≥
      const optimizedResult = bruteForceOptimization(origin, geocoded, setStatus);
      
      setStatus(`‚úÖ Optimaliz√°ci√≥ k√©sz! ${optimizedResult.route.length} c√≠m optim√°lis sorrendben (${geocoded.length !== lines.length ? `${lines.length} c√≠mb≈ël ${geocoded.length} siker√ºlt` : 'minden c√≠m feldolgozva'}).`, 'success');
      renderList(results, origin, optimizedResult);
      
      // Automatikus navig√°ci√≥ megnyit√°sa
      const app = document.getElementById("app").value;
      let href = null;
      
      if(optimizedResult.route.length > 0) {
        if(app === "google") {
          href = googleLink(origin, optimizedResult.route);
        } else if(app === "apple") {
          href = appleMultiLink(origin, optimizedResult.route);
          const isMobile = /iPhone|iPad|iPod/i.test(navigator.userAgent);
          if(isMobile && href) {
            window.location.href = href;
        } else if(href) {
          window.open(href, "_blank");
        }
        } else if(app === "waze") {
          href = wazeLink(origin, optimizedResult.route[0]);
        }
          
        if(href) {
          window.open(href, "_blank");
        }
      }
      
    } catch(error) {
      console.error("Hiba:", error);
      setStatus("‚ùå V√°ratlan hiba t√∂rt√©nt. Pr√≥b√°ld √∫jra.", 'error');
    } finally {
      goBtn.disabled = false;
      goBtn.textContent = "üß† Optim√°lis √∫tvonal keres√©se";
    }
  });
  
  // P√©lda c√≠mek bet√∂lt√©se
  const exampleAddresses = `Kossuth Lajos utca 5, Szeged
Dugonics t√©r 1, Szeged
R√°k√≥czi √∫t 12, Szeged
Aradi v√©rtan√∫k tere 1, Szeged`;
  
  if(!document.getElementById("addresses").value.trim()) {
    document.getElementById("addresses").value = exampleAddresses;
  }
}

// Alkalmaz√°s ind√≠t√°sa
window.addEventListener('load', main);
</script>
</body>
</html>




